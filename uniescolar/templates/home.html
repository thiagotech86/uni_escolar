{% extends 'base.html' %}

{% block title %}Página Inicial - Universo Escolar{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">

    {% if user.is_authenticated %}
        {# Seção para usuários autenticados: Lista de Aulas #}
        <h2 class="text-2xl font-semibold text-black dark:text-gray-50 mb-6 text-center">Minhas Aulas</h2>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow">
            <h4 class="text-lg font-semibold text-black dark:text-gray-200 mb-2 sm:mb-0">Total de hora/aula: <span id="totalHoras" class="text-blue-600 dark:text-blue-400">{{ total|default:"0.00" }}h</span></h4>
            <h4 class="text-lg font-semibold text-black dark:text-gray-200 text-right sm:text-left">Saldo de horas: <span id="saldoHoras" class="text-green-600 dark:text-green-400">-</span></h4>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow">
            <div>
                <label for="dataInicio" class="block text-sm font-medium text-black dark:text-gray-300 mb-1">Data de:</label>
                <input type="date" id="dataInicio" class="form-input-custom w-full dark:bg-gray-700 dark:text-gray-50 dark:border-gray-600">
            </div>
            <div>
                <label for="dataFim" class="block text-sm font-medium text-black dark:text-gray-300 mb-1">Até:</label>
                <input type="date" id="dataFim" class="form-input-custom w-full dark:bg-gray-700 dark:text-gray-50 dark:border-gray-600">
            </div>
            <div>
                <label for="filtroProfessor" class="block text-sm font-medium text-black dark:text-gray-300 mb-1">Professor:</label>
                <select id="filtroProfessor" class="form-input-custom w-full dark:bg-gray-700 dark:text-gray-50 dark:border-gray-600">
                    <option value="">Todos</option>
                </select>
            </div>
            <div>
                <label for="filtroAluno" class="block text-sm font-medium text-black dark:text-gray-300 mb-1">Aluno:</label>
                <select id="filtroAluno" class="form-input-custom w-full dark:bg-gray-700 dark:text-gray-50 dark:border-gray-600">
                    <option value="">Todos</option>
                </select>
            </div>
        </div>

        <hr class="border-t border-gray-300 dark:border-gray-600 my-6">

        <div class="overflow-x-auto bg-white dark:bg-gray-800 shadow-md rounded-lg">
            <table id="tabelaAulas" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black dark:text-gray-300 uppercase tracking-wider">ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black dark:text-gray-300 uppercase tracking-wider">Disciplina</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black dark:text-gray-300 uppercase tracking-wider">Data</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black dark:text-gray-300 uppercase tracking-wider">Início</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black dark:text-gray-300 uppercase tracking-wider">Término</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black dark:text-gray-300 uppercase tracking-wider">Aluno</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black dark:text-gray-300 uppercase tracking-wider">Professor</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black dark:text-gray-300 uppercase tracking-wider">Total Horas</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-black dark:text-gray-300 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% if aulas %}
                        {% for aula in aulas %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline">
                                <a href="{% url 'aula' aula.id %}">{{ aula.id }}</a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-gray-300">{{ aula.disciplina }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-gray-300 filtro-data" data-date="{{ aula.data_inicio|date:'Y-m-d' }}">{{ aula.data_inicio|date:"d/m/Y" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-gray-300 hora-inicio">{{ aula.hora_inicio|time:"H:i" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-gray-300 hora-fim">{{ aula.hora_fim|time:"H:i" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-gray-300">{{ aula.aluno }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-gray-300">{{ aula.professor }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-gray-300 duracao">{{ aula.duracao }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button class="btn-excluir bg-red-500 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded text-xs shadow hover:shadow-md transition-all duration-150" data-id="{{ aula.id }}">Excluir</button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-center">Nenhuma aula disponível.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {{ horas_contratadas_aluno|json_script:"dadosContratadosPorAluno" }}
        {{ total_contratado_todos|json_script:"dadosTotalContratado" }}

    {% else %}
        
        <div class="flex justify-center items-center py-8 min-h-[calc(100vh-200px)]">
            <div class="w-full max-w-md">
                
                <div class="form-card px-6 py-8 dark:bg-gray-800 rounded-lg shadow-xl"> 
                    <h2 class="text-3xl font-bold text-center text-black dark:text-white mb-2">Bem-vindo!</h2>
                    <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Faça login para continuar</p>

                    <form method="post" action="{% url 'home' %}"> 
                        {% csrf_token %}
                        <div class="mb-5">
                            <label for="username-home" class="block text-black dark:text-gray-300 text-sm font-bold mb-2">
                                Usuário:
                            </label>
                           
                            <input type="text" id="username-home" name="username" placeholder="Insira o usuário"
                                   class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
                        </div>

                        <div class="mb-6">
                            <label for="password-home" class="block text-black dark:text-gray-300 text-sm font-bold mb-2">
                                Senha:
                            </label>
                        
                            <input type="password" id="password-home" name="password" placeholder="Insira a senha"
                                   class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out" required>
                        </div>
                        
                        <div class="mb-6">
                            <label for="userType-home" class="block text-black dark:text-gray-300 text-sm font-bold mb-2">
                                Eu sou:
                            </label>
                           
                            <select id="userType-home" name="user_type"
                                    class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 bg-white text-black focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 ease-in-out leading-tight">
                                <option value="aluno_responsavel" class="text-black bg-white">Aluno/Responsável</option>
                                <option value="professor" class="text-black bg-white">Professor</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center justify-center mt-8">
                            <button type="submit"
                                    class="btn-primary-custom w-full py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline hover:opacity-90 transition-opacity duration-150">
                                Entrar
                            </button>
                        </div>
                         <p class="text-center text-gray-600 dark:text-gray-400 mt-6 text-sm">
                            Não tem uma conta? 
                            <a href="{% url 'register' %}" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">Cadastre-se</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}
</div>

{% if user.is_authenticated %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const dataInicio = document.getElementById("dataInicio");
    const dataFim = document.getElementById("dataFim");
    const filtroProfessor = document.getElementById("filtroProfessor");
    const filtroAluno = document.getElementById("filtroAluno");
    const tabelaAulasBody = document.querySelector("#tabelaAulas tbody");

    let horasContratadasPorAluno = {};
    let totalContratadoTodos = 0;

    try {
        const dadosContratadosElement = document.getElementById("dadosContratadosPorAluno");
        if (dadosContratadosElement) {
            horasContratadasPorAluno = JSON.parse(dadosContratadosElement.textContent);
        }
    } catch (e) {
        console.error("Erro ao carregar dadosContratadosPorAluno:", e);
    }

    try {
        const dadosTotalContratadoElement = document.getElementById("dadosTotalContratado");
        if (dadosTotalContratadoElement) {
            totalContratadoTodos = JSON.parse(dadosTotalContratadoElement.textContent);
        }
    } catch (e) {
        console.error("Erro ao carregar dadosTotalContratado:", e);
    }
    
    function popularFiltros() {
        const professores = new Set();
        const alunos = new Set();

        document.querySelectorAll("#tabelaAulas tbody tr").forEach(row => {
            if (row.children.length > 6) { 
                const alunoNome = row.children[5]?.textContent.trim();
                const profNome = row.children[6]?.textContent.trim();
                if (alunoNome) alunos.add(alunoNome);
                if (profNome) professores.add(profNome);
            }
        });

        while (filtroProfessor.options.length > 1) filtroProfessor.remove(1);
        professores.forEach(nome => {
            const opt = document.createElement("option");
            opt.value = nome;
            opt.textContent = nome;
            filtroProfessor.appendChild(opt);
        });

        while (filtroAluno.options.length > 1) filtroAluno.remove(1);
        alunos.forEach(nome => {
            const opt = document.createElement("option");
            opt.value = nome;
            opt.textContent = nome;
            filtroAluno.appendChild(opt);
        });
    }

    function aplicarFiltro() {
        if (!tabelaAulasBody) return; 

        const inicio = dataInicio.value;
        const fim = dataFim.value;
        const prof = filtroProfessor.value.toLowerCase();
        const aluno = filtroAluno.value.toLowerCase();
        let totalHorasCalculado = 0;
        let algumaLinhaVisivel = false;

        document.querySelectorAll("#tabelaAulas tbody tr").forEach(row => {
            if (row.children.length === 1 && row.children[0].getAttribute('colspan')) {
                row.style.display = "none"; 
                return;
            }
            if (row.children.length < 8) return; 

            const dataCelula = row.querySelector(".filtro-data");
            const dataValor = dataCelula?.getAttribute("data-date");
            const profValor = row.children[6]?.textContent.toLowerCase();
            const alunoValor = row.children[5]?.textContent.toLowerCase();

            let visivel = true;

            if (inicio && dataValor < inicio) visivel = false;
            if (fim && dataValor > fim) visivel = false;
            if (prof && profValor !== prof) visivel = false; 
            if (aluno && alunoValor !== aluno) visivel = false; 

            row.style.display = visivel ? "" : "none";

            if (visivel) {
                algumaLinhaVisivel = true;
                const duracaoTexto = row.querySelector(".duracao")?.innerText.replace(",", ".");
                const horas = parseFloat(duracaoTexto);
                if (!isNaN(horas)) totalHorasCalculado += horas;
            }
        });
        
        const totalHorasSpan = document.getElementById("totalHoras");
        if (totalHorasSpan) totalHorasSpan.innerText = totalHorasCalculado.toFixed(2) + "h";

        let alunoSelecionado = filtroAluno.value.trim();
        let professorSelecionado = filtroProfessor.value.trim();
        let contratado = 0;
        let saldo = 0;

        if (professorSelecionado) {
            saldo = 0; 
        } else if (alunoSelecionado) {
            contratado = horasContratadasPorAluno[alunoSelecionado] || 0;
            saldo = contratado - totalHorasCalculado;
        } else {
            const alunosVisiveis = new Set();
            document.querySelectorAll("#tabelaAulas tbody tr").forEach(row => {
                if (row.style.display !== "none" && row.children.length > 5) {
                    const alunoNome = row.children[5]?.textContent.trim();
                    if (alunoNome) alunosVisiveis.add(alunoNome);
                }
            });

            if (alunosVisiveis.size === 1) {
                const nomeUnico = [...alunosVisiveis][0];
                contratado = horasContratadasPorAluno[nomeUnico] || 0;
            } else {
                contratado = totalContratadoTodos || 0; 
            }
            saldo = contratado - totalHorasCalculado;
        }
        
        const saldoHorasSpan = document.getElementById("saldoHoras");
        if (saldoHorasSpan) saldoHorasSpan.innerText = saldo.toFixed(2) + "h";

        const nenhumaAulaRow = tabelaAulasBody.querySelector("tr td[colspan='9']");
        if (!algumaLinhaVisivel) {
            if (!nenhumaAulaRow) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.setAttribute('colspan', '9');
                td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 text-center';
                td.textContent = 'Nenhuma aula disponível para os filtros selecionados.';
                tr.appendChild(td);
                tabelaAulasBody.appendChild(tr);
            } else {
                 nenhumaAulaRow.parentElement.style.display = ""; 
            }
        } else {
            if (nenhumaAulaRow) {
                nenhumaAulaRow.parentElement.style.display = "none"; 
            }
        }
    }

    document.querySelectorAll('.btn-excluir').forEach(button => {
        button.addEventListener('click', function () {
            if (!confirm("Tem certeza que deseja excluir esta aula?")) return;

            const aulaId = this.getAttribute('data-id');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}';

            fetch(`/excluir-aula/${aulaId}/`, { 
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken, 
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    this.closest('tr').remove();
                    popularFiltros(); 
                    aplicarFiltro(); 
                } else {
                    alert("Erro ao excluir: " + (data.mensagem || "Erro desconhecido."));
                }
            })
            .catch((error) => {
                console.error("Erro de conexão ao excluir a aula:", error);
                alert("Erro de conexão ao excluir a aula.");
            });
        });
    });

    if (dataInicio) dataInicio.addEventListener("change", aplicarFiltro);
    if (dataFim) dataFim.addEventListener("change", aplicarFiltro);
    if (filtroProfessor) filtroProfessor.addEventListener("input", aplicarFiltro);
    if (filtroAluno) filtroAluno.addEventListener("input", aplicarFiltro);

    if (document.querySelector("#tabelaAulas tbody tr td[colspan='9']") === null) { 
       popularFiltros();
    }
    aplicarFiltro(); 
});
</script>
{% endif %}

{% endblock %}
