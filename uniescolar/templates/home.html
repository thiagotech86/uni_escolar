{% extends 'base.html' %}

{% block content %}
    {% if user.is_authenticated %}
<h2 class="text-center">Aulas</h2>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Total de hora/aula: <span id="totalHoras">{{ total }}h</span></h4>
  <h4 class="text-end">Saldo de horas: <span id="saldoHoras">-</span></h4>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <label>Data de:</label>
    <input type="date" id="dataInicio" class="form-control">
  </div>
  <div class="col-md-3">
    <label>Até:</label>
    <input type="date" id="dataFim" class="form-control">
  </div>
  <div class="col-md-3">
    <label>Professor:</label>
    <select id="filtroProfessor" class="form-select">
      <option value="">Todos</option>
    </select>
  </div>
  <div class="col-md-3">
    <label>Aluno:</label>
    <select id="filtroAluno" class="form-select">
      <option value="">Todos</option>
    </select>
  </div>
</div>

<hr>

<table class="table table-striped table-bordered table-hover" id="tabelaAulas">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Disciplina</th>
      <th>Data</th>
      <th>Início</th>
      <th>Término</th>
      <th>Aluno</th>
      <th>Professor</th>
      <th>Total Horas</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
    {% if aulas %}
      {% for aula in aulas %}
        <tr>
          <td><a href="{% url 'aula' aula.id %}">{{ aula.id }}</a></td>
          <td>{{ aula.disciplina }}</td>
          <td class="filtro-data" data-date="{{ aula.data_inicio|date:'Y-m-d' }}">{{ aula.data_inicio|date:'d/m/Y' }}</td>
          <td class="hora-inicio">{{ aula.hora_inicio|time:"H:i" }}</td>
          <td class="hora-fim">{{ aula.hora_fim|time:"H:i" }}</td>
          <td>{{ aula.aluno }}</td>
          <td>{{ aula.professor }}</td>
          <td class="duracao">{{ aula.duracao }}</td>
          <td>
            <button class="btn btn-danger btn-excluir" data-id="{{ aula.id }}">Excluir</button>
          </td>
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="9" class="text-center">Nenhuma aula disponível.</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<!-- Injetando dados de horas contratadas por aluno -->
    {{ horas_contratadas_aluno|json_script:"dadosContratadosPorAluno" }}
    {{ total_contratado_todos|json_script:"dadosTotalContratado" }}

    <script>
        const horasContratadasPorAluno = JSON.parse(document.getElementById("dadosContratadosPorAluno").textContent);
        const totalContratadoTodos = JSON.parse(document.getElementById("dadosTotalContratado").textContent);
    </script>

<script>
  function atualizarTotalHoras() {
    let totalHoras = 0;
    document.querySelectorAll('.duracao').forEach(function (duracaoCelula) {
      let valor = parseFloat(duracaoCelula.innerText.replace(',', '.'));
      if (!isNaN(valor)) {
        totalHoras += valor;
      }
    });
    document.getElementById('totalHoras').innerText = totalHoras.toFixed(2) + 'h';
  }
  atualizarTotalHoras();
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.btn-excluir').forEach(button => {
      button.addEventListener('click', function () {
        if (!confirm("Tem certeza que deseja excluir esta aula?")) return;

        const aulaId = this.getAttribute('data-id');
        fetch(`/excluir-aula/${aulaId}/`, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}',
          },
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'ok') {
              this.closest('tr').remove();
              aplicarFiltro(); // atualiza total e saldo
            } else {
              alert("Erro ao excluir: " + data.mensagem);
            }
          })
          .catch(() => {
            alert("Erro de conexão ao excluir a aula.");
          });
      });
    });

    const dataInicio = document.getElementById("dataInicio");
    const dataFim = document.getElementById("dataFim");
    const filtroProfessor = document.getElementById("filtroProfessor");
    const filtroAluno = document.getElementById("filtroAluno");

    const professores = new Set();
    const alunos = new Set();

    document.querySelectorAll("#tabelaAulas tbody tr").forEach(row => {
      const prof = row.children[6]?.textContent.trim();
      const aluno = row.children[5]?.textContent.trim();
      if (prof) professores.add(prof);
      if (aluno) alunos.add(aluno);
    });

    professores.forEach(nome => {
      const opt = document.createElement("option");
      opt.value = nome;
      opt.textContent = nome;
      filtroProfessor.appendChild(opt);
    });

    alunos.forEach(nome => {
      const opt = document.createElement("option");
      opt.value = nome;
      opt.textContent = nome;
      filtroAluno.appendChild(opt);
    });

    function aplicarFiltro() {
      const inicio = dataInicio.value;
      const fim = dataFim.value;
      const prof = filtroProfessor.value.toLowerCase();
      const aluno = filtroAluno.value.toLowerCase();
      let totalHoras = 0;

      document.querySelectorAll("#tabelaAulas tbody tr").forEach(row => {
        const dataCelula = row.querySelector(".filtro-data");
        const dataValor = dataCelula?.getAttribute("data-date");
        const profValor = row.children[6]?.textContent.toLowerCase();
        const alunoValor = row.children[5]?.textContent.toLowerCase();

        let visivel = true;

        if (inicio && dataValor < inicio) visivel = false;
        if (fim && dataValor > fim) visivel = false;
        if (prof && !profValor.includes(prof)) visivel = false;
        if (aluno && !alunoValor.includes(aluno)) visivel = false;

        row.style.display = visivel ? "" : "none";

        if (visivel) {
          const duracaoTexto = row.children[7]?.innerText.replace(",", ".");
          const horas = parseFloat(duracaoTexto);
          if (!isNaN(horas)) totalHoras += horas;
        }
      });

      document.getElementById("totalHoras").innerText = totalHoras.toFixed(2) + "h";

      // saldo de horas com base no aluno selecionado

        let alunoSelecionado = filtroAluno.value.trim();
        let professorSelecionado = filtroProfessor.value.trim();
        let contratado = 0;
        let saldo = 0;

        if (professorSelecionado) {
            // Professor específico → saldo zero
            saldo = 0;
        } else if (alunoSelecionado) {
            // Aluno específico → usa o pacote dele
            contratado = horasContratadasPorAluno[alunoSelecionado] || 0;
            saldo = contratado - totalHoras;
        } else {
            // Filtro de aluno = Todos → verificar quantos alunos únicos restaram visíveis
            const alunosVisiveis = new Set();

            document.querySelectorAll("#tabelaAulas tbody tr").forEach(row => {
                if (row.style.display !== "none") {
                    const alunoNome = row.children[5]?.textContent.trim();
                    if (alunoNome) alunosVisiveis.add(alunoNome);
                }
            });

            if (alunosVisiveis.size === 1) {
                // Apenas um aluno visível → trata como filtro individual
                const nomeUnico = [...alunosVisiveis][0];
                contratado = horasContratadasPorAluno[nomeUnico] || 0;
            } else {
                // Caso contrário, soma geral
                contratado = totalContratadoTodos || 0;
            }

            saldo = contratado - totalHoras;
        }

        document.getElementById("saldoHoras").innerText = saldo.toFixed(2) + "h";


    }

    dataInicio.addEventListener("change", aplicarFiltro);
    dataFim.addEventListener("change", aplicarFiltro);
    filtroProfessor.addEventListener("input", aplicarFiltro);
    filtroAluno.addEventListener("input", aplicarFiltro);
  });
</script>
{% else %}
<!-- Login padrão -->
<h2 class="text-center">Login</h2>
<hr>
<form method="post" action="{% url 'home' %}">
  {% csrf_token %}
  <div class="mb-3">
    <label class="form-label">Usuário</label>
    <input type="text" name="usuario" class="form-control" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Senha</label>
    <input type="password" name="senha" class="form-control" required>
  </div>
  <button class="btn btn-primary" type="submit">Login</button>
</form>
    {% endif %}
{% endblock %}
